<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <title></title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.29.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.29.0/mapbox-gl.css' rel='stylesheet' />
  <link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css"
    integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
  <script src="https://d3js.org/d3-queue.v3.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      left: 0;
      top: 16px;
      height: 100%;
      width: 100%;
    }

    #mapbak {
      position: absolute;
      top: 420px;
      bottom: 0;
      width: 100%;
    }

    #reset {
      position: relative;
      bottom: 25px;
      left: 20px;
      z-index: 999;
    }

    .mb-4,.my-4 {
      margin-bottom: 3.0rem !important;
    }

    .jumbotron {
      padding: 2rem 1rem;
      margin-bottom: 2rem;
      background-color: #e9ecef;
      border-radius: .3rem;
      height: 100%;
      /* panenno input e mappa*/
    }

    .container-fluid {
      width: 100%;
      padding-right: 15px;
      padding-left: 15px;
      margin-right: auto;
      margin-left: auto;
      height: auto;
    }

    .round {
      border-radius: 5px;
      /*Box dei risultati*/
      margin-top: 50px;
      /*50px*/
    }

    .tableFixHeadDiv {
      overflow-y: auto;
      height: 150px;
    }
    .tableFixHead{
      position: sticky;
      top: 0;
      background:#0066DB;
      color:white;
    }
  </style>
  <!-- <link rel="canonical" href="https://labs.mapbox.com/bites/00321/" > -->
</head>

<body>
  <!-- <a href='#' id='reset' class='button fill-darken1'>reset</a> -->

  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-4 mb-4">
        <div class="jumbotron mt-3">
          <h1>Progetto NextSHOP</h1>
          <p class="lead">Prototipo LastMile.</p>
          <!-- <a class="btn btn-lg btn-primary" href="/demo/" role="button">Demo &raquo;</a> -->
          <p>Acquisisci le coordinate delle posizioni dei clienti da file JSON.</p>
          <div id="divForm" class="custom-file">
            <form id="formUp" class="custom-file" enctype="multipart/form-data" method="post" onchange="formChange()">
              <input type="file" name="file" class="custom-file-input" id="customFile">
              <label id="labelFile" class="custom-file-label" for="customFile">Scegli file</label>
              </br></br>
              <button id="buttonLoad" onclick="submitFile()" type="submit" class="btn btn-primary">Carica
                &raquo;</button>
              <!-- Label di caricamento -->
              <label id="checkFile" for="buttonLoad"></label>
            </form>
          </div>

          <hr class="my-4">

          <div id="spedizioniereInput1" class="form-group">
            <p>Oppure acquisisci le coordinate delle posizioni dei clienti e del deposito in modo manuale, poi clicca su
              Invia.</p>
            <p>Inserire latitudine e longitudine per ogni punto di consegna.</p>
            <table id='tableDEP'>
              <tr>Deposito</tr>
              <td style="border: none">
                Lat:
                <input id="latDep" type="text" size="14">
                Lon:
                <input id="lonDep" type="text" size="14">
              </td>
            </table>
            </br>
            <p>Seleziona il numero di clienti che gli spedizioniere dovranno servire.</p>
            Primo Spedizioniere
            <select class="form-control" id="selezioneSpedizione1"
              onchange="inputSpedizioniereX('tableIN1','selezioneSpedizione1','labelIN1')">
              <option>0</option>
              <option>1</option>
              <option>2</option>
              <option>3</option>
              <option>4</option>
              <option>5</option>
              <option>6</option>
              <option>7</option>
              <option>8</option>
              <option>9</option>
              <option>10</option>
            </select>
            <label id='labelIN1' for="exampleFormControlSelect1" style="display: none">Inserire latitudine e longitudine
              per ogni punto di consegna.</label>
            <table id='tableIN1'></table>

            </br>

            Secondo Spedizioniere
            <select class="form-control" id="selezioneSpedizione2"
              onchange="inputSpedizioniereX('tableIN2','selezioneSpedizione2','labelIN2')">
              <option>0</option>
              <option>1</option>
              <option>2</option>
              <option>3</option>
              <option>4</option>
              <option>5</option>
              <option>6</option>
              <option>7</option>
              <option>8</option>
              <option>9</option>
              <option>10</option>
            </select>
            <label id='labelIN2' for="exampleFormControlSelect2" style="display: none">Inserire latitudine e longitudine
              per ogni punto di consegna.</label>
            <table id='tableIN2'></table>

            </br>

            <button id="buttonLoadManual" onclick="coordinateManual()" type="submit" class="btn btn-primary">Invia
              &raquo;</button>
            <!-- Label di caricamento -->
            <label id="checkManual" for="buttonLoadManual"></label>
          </div>

          <hr class="my-4">

          <p>Oppure inserisci il numero di clienti del primo e del secondo spedizioniere e clicca su
            Demo!<br>L'applicazione genererà automaticamente le posizioni dei clienti sulla mappa.</p>
          <div class="form-group">
            <label for="exampleFormControlSelect1">Seleziona il numero di clienti da servire per il primo
              spedizioniere.</label>
            <select class="form-control" id="selezioneship1">
              <option>1</option>
              <option>2</option>
              <option>3</option>
              <option>4</option>
              <option>5</option>
              <option>6</option>
              <option>7</option>
              <option>8</option>
              <option>9</option>
              <option>10</option>
            </select>
          </div>
          <div class="form-group">
            <label for="exampleFormControlSelect1">Seleziona il numero di clienti da servire per il secondo
              spedizioniere.</label>
            <select class="form-control" id="selezioneship2">
              <option>1</option>
              <option>2</option>
              <option>3</option>
              <option>4</option>
              <option>5</option>
              <option>6</option>
              <option>7</option>
              <option>8</option>
              <option>9</option>
              <option>10</option>
            </select>
          </div>
          <p>
            <button id="demo" onclick="solve()" class="btn btn-primary" type="button">Demo &raquo;</button>

          </p>

          <hr class="my-4">
          <p>L'applicazione ottimizzerà se è possibile i risultati dei clienti.</p>
          <button id="coperate" onclick="cooperate()" class="btn btn-secondary my-2" type="button">Avvia cooperazione
            &raquo;</button>
        </div>
      </div>
      <!--
    <nav class="navbar fixed-bottom navbar-expand-sm navbar-dark bg-dark">
      <a class="navbar-brand" href="#">Bottom navbar</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarCollapse">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item active">
            <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Link</a>
          </li>
          <li class="nav-item">
            <a class="nav-link disabled" href="#">Disabled</a>
          </li>
          <li class="nav-item dropup">
            <a class="nav-link dropdown-toggle" href="https://getbootstrap.com/" id="dropdown10" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Dropup</a>
            <div class="dropdown-menu" aria-labelledby="dropdown10">
              <a class="dropdown-item" href="#">Action</a>
              <a class="dropdown-item" href="#">Another action</a>
              <a class="dropdown-item" href="#">Something else here</a>
            </div>
          </li>
        </ul>
      </div>
    </nav> -->

      <div class="col-lg-8">

        <div class="row">
        
          <div class="col mb-4">
            <div class="jumbotron mt-3">
              <div class="row">
                  <h2>Tabella Consegne</h2>
              </div>

              <div class="row">
                  <div class="col mb-4">
                      <h5>Primo Spedizioniere</h5>
                      <div class="tableFixHeadDiv">
                      <table id='tableCons1' class="table">
                        <thead>
                          <tr>
                            <th class="tableFixHead">Consegna</th>
                            <th class="tableFixHead">Latitudine</th>
                            <th class="tableFixHead">Longitudine</th>
                          </tr>
                        </thead>
                        <tbody id="bodyTable1" style="font-size: 15px"></tbody>
                      </table>
                      </div>
                  </div>
                  
                  <div class="col mb-4">
                      <h5>Secondo Spedizioniere</h5>
                      <div class="tableFixHeadDiv">
                      <table id='tableCons2' class="table">
                        <thead>
                          <tr>
                            <th class="tableFixHead">Consegna</th>
                            <th class="tableFixHead">Latitudine</th>
                            <th class="tableFixHead">Longitudine</th>
                          </tr>
                        </thead>
                        <tbody id="bodyTable2" style="font-size: 15px"></tbody>
                      </table>
                      </div>
                  </div>
                </div> <!-- row table -->
              </div> <!-- div jumbotron mt-3 -->
          </div> <!-- div colonanna report consegne-->

        </div> <!-- row -->

        <div class="row">
          <div class="col">
            <div id="map" style="height: 1000px"></div>
            <div class='clearfix contain'>
              <div class='pin-topright space-right2 space-top2 width28 pad2x pad1y round fill-white'>
                <!--
      <div class='small pad2y keyline-bottom'>
        <div class='fill-cyan dark space-top1_5 fl pad0 center dot'> <span class='icon car' /></div>
        <div class='strong space-left4'>Driving directions</div>
        <div class='quiet space-left4'>Routes on the fastest roads and around traffic.</div>
      </div> -->
                <div class='small pad2y keyline-bottom'>
                  <div class='fl space-top1_5 pad0 fill-green dark center dot'> <span class='fas fa-truck' /></div>
                  <div class='strong space-left4'>Primo spedizioniere</div>
                  <div id='0' class='quiet space-left4'>Nessun dato.</div>
                </div>
                <div class='small pad2y keyline-bottom'>
                  <div class='fl space-top1_5 pad0 fill-mustard dark center dot'> <span class='fas fa-truck' /></div>
                  <div class='strong space-left4'>Secondo spedizioniere</div>
                  <div id='1' class='quiet space-left4'>Nessun dato.</div>
                </div>
                <div class='small pad2y'>
                  <div class='fl space-top1_5 pad0 fill-blue dark center dot'> <span class='fas fa-user-friends' />
                  </div>
                  <div class='strong space-left4'>Cooperazione</div>
                  <div id='2' class='quiet space-left4'>Nessun dato.</div>
                </div>
              </div>
            </div>
          </div>
        
        </div> <!-- row -->

      </div> <!-- div colo-lg-8 -->
    </div>

  </div>

  {{ value|json_script:"hello-data" }}

  <script>

    var StartingIndex = 0;

    var value = JSON.parse(document.getElementById('hello-data').textContent);


    var obj = {};

    mapboxgl.accessToken = 'pk.eyJ1IjoiYWFyb25saWRtYW4iLCJhIjoiNTVucTd0TSJ9.wVh5WkYXWJSBgwnScLupiQ';
    //#9/38.9305/17.1289
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v9',
      center: [16.9722, 38.6447],
      zoom: 9,
      hash: true
    });

    map.scrollZoom.disable();
    var nav = new mapboxgl.NavigationControl();
    map.addControl(nav, 'top-left');

    //map.on('load', run);

    var IDrotta = 0;

    var c = 0;
    colors = ['#56b881', '#fbb03b', '#3bb2d0']

    var points = [];

    //Metodoti inseriti ora

    function uploadFile(event) {
      event.preventDefault();
      var dataFile = new FormData($('#formUp').get(0));
      document.getElementById('checkFile').innerHTML = "Caricamento..."
      $.ajax({
        url: "/upload/",
        type: "POST",
        data: dataFile,
        cache: false,
        processData: false,
        contentType: false,
        complete: function () {
          document.getElementById(2).innerHTML = "Nessun dato.";
        },
        success: function (response) {
          if (response != "-1") {
            value = JSON.parse(JSON.stringify(response));

            var clienti1 = value['clienti1'];
            var rotta1 = value['rotta1'];
            var costo1 = parseFloat(Math.round(value['costo1'] * 100) / 100).toFixed(2);
            createTableConsegne('bodyTable1', clienti1, rotta1);

            var clienti2 = value['clienti2'];
            var rotta2 = value['rotta2'];
            var costo2 = parseFloat(Math.round(value['costo2'] * 100) / 100).toFixed(2);
            createTableConsegne('bodyTable2', clienti2, rotta2);

            run3(clienti1, rotta1, costo1, '0', true);
            run3(clienti2, rotta2, costo2, '1', false);

            document.getElementById('checkFile').innerHTML = "Caricato  &#x2714";

          }
          else {
            document.getElementById('checkFile').innerHTML = "Errore  &#x274C";
          }
        },
        error: function (err) {
          document.getElementById('checkFile').innerHTML = "Errore  &#x274C";
          console.log(err);
          
        }
      });
      return false;
    }
    function submitFile() {
      $('#formUp').submit(uploadFile)
    }

    function formChange() {
      document.getElementById("demo").disabled = false
      document.getElementById('checkFile').innerHTML = ""
      document.getElementById('labelFile').innerHTML = "Scegli file"
      var fullPath = document.getElementById('customFile').value;
      if (fullPath.length != 0) {
        var index = fullPath.lastIndexOf('\\') + 1
        var name = fullPath.substring(index);
        document.getElementById('labelFile').innerHTML = name
      }
    }

    function inputSpedizioniereX(tableCod, selectSpedCod, labelCod) {
      //"spedizioniereInput"
      document.getElementById('checkManual').innerHTML = "";
      var table = document.getElementById(tableCod);
      table.innerHTML = "";
      var number = parseInt(document.getElementById(selectSpedCod).value);
      if (number != 0) {
        document.getElementById(labelCod).style.display = 'block';
      }
      else {
        document.getElementById(labelCod).style.display = 'none';
      }

      for (i = 0; i < number; i++) {
        var tr = document.createElement('tr');
        var td = document.createElement('td');
        td.style.border = 'none'
        td.append((i + 1) + ") Lat:  ");
        var inputLat = document.createElement("input");
        inputLat.setAttribute('size', 6)
        td.appendChild(inputLat);
        td.append("       Lon:  ");
        var inputLon = document.createElement("input");
        inputLon.setAttribute('size', 6)
        td.appendChild(inputLon);
        tr.appendChild(td);
        table.appendChild(tr);
      }

    }

    function readTable(code, indice) {
      var table = document.getElementById('tableIN' + code);
      var coord = '{"noc":' + (table.rows.length + 1) + ',"pos":[{';
      var latDep = document.getElementById('latDep').value
      var lonDep = document.getElementById('lonDep').value
      coord = coord + '"0":"(' + latDep + ',' + lonDep + ')",';
      for (i = 0; i < table.rows.length; i++) {
        var lat = table.rows.item(i).cells[0].getElementsByTagName('input')[0].value;
        var lon = table.rows.item(i).cells[0].getElementsByTagName('input')[1].value;
        coord = coord + '"' + indice + '":"(' + lat + ',' + lon + ')"';
        indice = indice + 1;
        if (i != table.rows.length - 1)
          coord = coord + ',';
      }
      coord = coord + '}]}';
      return [coord, indice];
    }

    function coordinateManual() {
      event.preventDefault();
      var valueSp1 = readTable(1, 1);
      var valueSp2 = readTable(2, valueSp1[1]);
      var dataSend = valueSp1[0] + "\n" + valueSp2[0];
      document.getElementById('checkManual').innerHTML = "Caricamento...";
      $.ajax({
        url: "/manual/",
        type: "POST",
        data: dataSend,
        cache: false,
        processData: false,
        contentType: 'charset=UTF-8',
        success: function (response) {
          if (response != -1) {
            value = JSON.parse(JSON.stringify(response));
            //  console.log("Solve:");
            // console.log(value);
            var clienti1 = value['clienti1'];
            var rotta1 = value['rotta1'];
            var costo1 = parseFloat(Math.round(value['costo1'] * 100) / 100).toFixed(2);
            createTableConsegne('bodyTable1', clienti1, rotta1);

            var clienti2 = value['clienti2'];
            var rotta2 = value['rotta2'];
            var costo2 = parseFloat(Math.round(value['costo2'] * 100) / 100).toFixed(2);
            createTableConsegne('bodyTable2', clienti2, rotta2);

            run3(clienti1, rotta1, costo1, '0', true);
            run3(clienti2, rotta2, costo2, '1', false);
            document.getElementById('checkManual').innerHTML = "Caricato  &#x2714";
          }
          else {
            document.getElementById('checkManual').innerHTML = "Errore  &#x274C"
          }
        },
        error: function (err) {
          document.getElementById('checkManual').innerHTML = "Errore  &#x274C"
          console.log(err);
        }
      });
      return false;
    }

    function createTableConsegne(tableBodyCod, client, route) {
      var tableBody = document.getElementById(tableBodyCod);
      tableBody.innerHTML = "";
      client[0];
      coords = client[0];
      lat = coords[0];
      lon = coords[1];
      var tr = document.createElement('tr');
      var tdNum = document.createElement('td');
      tdNum.style.backgroundColor = "white"
      tdNum.append("Deposito")
      tr.appendChild(tdNum);
      var tdLat = document.createElement('td');
      tdLat.style.backgroundColor = "white"
      tdLat.append(lat)
      tr.appendChild(tdLat);
      var tdLon = document.createElement('td');
      tdLon.style.backgroundColor = "white"
      tdLon.append(lon)
      tr.appendChild(tdLon);
      tableBody.appendChild(tr);
      for (var i = 0; i < route[0][0].length; i++) {
        var key = parseInt(route[0][0][i]);
        coords = client[key];
        lat = coords[0].toFixed(8);
        lon = coords[1].toFixed(8);
        var tr = document.createElement('tr');
        var tdNum = document.createElement('td');
        tdNum.style.backgroundColor = "white"
        tdNum.append(key)
        tr.appendChild(tdNum);
        var tdLat = document.createElement('td');
        tdLat.style.backgroundColor = "white"
        tdLat.append(lat)
        tr.appendChild(tdLat);
        var tdLon = document.createElement('td');
        tdLon.style.backgroundColor = "white"
        tdLon.append(lon)
        tr.appendChild(tdLon);
        tableBody.appendChild(tr);
      }
    }


    //Metodo di prima

    function solve() {

      var noc1 = document.getElementById('selezioneship1').value;
      var noc2 = document.getElementById('selezioneship2').value;
      var obj1 = { 'noc1': noc1, 'noc2': noc2 };
      var myJSON = JSON.stringify(obj1);

      $.ajax({
        type: 'POST',
        url: '/demo/',

        //{#                data: name#}
        data: myJSON,
        contentType: 'application/json;charset=UTF-8',
        async: false,
        dataType: 'json',
        success: function (response) {

          value = JSON.parse(JSON.stringify(response));
          //  console.log("Solve:");
          // console.log(value);
          var clienti1 = value['clienti1'];
          var rotta1 = value['rotta1'];
          var costo1 = parseFloat(Math.round(value['costo1'] * 100) / 100).toFixed(2);
          createTableConsegne('bodyTable1', clienti1, rotta1);

          var clienti2 = value['clienti2'];
          var rotta2 = value['rotta2'];
          var costo2 = parseFloat(Math.round(value['costo2'] * 100) / 100).toFixed(2);
          createTableConsegne('bodyTable2', clienti2, rotta2);

          run3(clienti1, rotta1, costo1, '0', true);
          run3(clienti2, rotta2, costo2, '1', false);
          //document.getElementById(2).innerHTML = "Nessun dato.";
          //document.location.reload(true);
          //alert("The text has been changed." + name);
        },
        error: function (err) {
          console.log(err);
        }
      });
    }
    /*
    function demo() {
                var name = "frasec";
                var obj1 = {'FileName':name};
                var myJSON = JSON.stringify(obj1);
    
               $.ajax({
                    type: 'POST',
                    url: '/demo/',
    
    //{#                data: name#}
                    data:myJSON,
                    contentType: 'application/json;charset=UTF-8',
                    async: false,
                    dataType: 'json',
                    success: function (response) {
                      console.log(JSON.stringify(response));
                      value = JSON.parse(JSON.stringify(response));
                      console.log(value);
                      IDrotta = 0;
                      //obj[IDrotta] = value;
                      run();
                      //document.location.reload(true);
                        //alert("The text has been changed." + name);
                    },
                    error: function (err) {
                          console.log(err);
                    }
                });
    
               $.ajax({
                    type: 'POST',
                    url: '/demo/',
    
    //{#                data: name#}
                    data:myJSON,
                    contentType: 'application/json;charset=UTF-8',
                    async: false,
                    dataType: 'json',
                    success: function (response) {
                      console.log(JSON.stringify(response));
                      value = JSON.parse(JSON.stringify(response));
                      IDrotta = 1;
                      //obj[IDrotta] = value;
                      run();
                      //document.location.reload(true);
                        //alert("The text has been changed." + name);
                    },
                    error: function (err) {
                          console.log(err);
                    }
                });
    }
    */
    function cooperate() {

      var clienti1 = value['clienti1'];
      var clienti2 = value['clienti2'];
      /*
                var name = "frasec";
                var lat = value['lat'];
                var lon = value['lon'];
                var rotta = value['rotta'];
    */
      var obj = { 'clienti1': clienti1, 'clienti2': clienti2 };

      var myJSON = JSON.stringify(obj);
      // console.log(myJSON);

      $.ajax({
        type: 'POST',
        url: '/cooperation/',

        data: myJSON,
        contentType: 'application/json;charset=UTF-8',
        async: false,
        dataType: 'json',
        success: function (response) {

          value = JSON.parse(JSON.stringify(response));
          //console.log("cooperate: ");
          //console.log(value);
          var clienti1 = value['clienti1'];
          var rotta1 = value['rotta1'];
          var costo1 = parseFloat(Math.round(value['costo1'] * 100) / 100).toFixed(2);
          createTableConsegne('bodyTable1', clienti1, rotta1);

          var clienti2 = value['clienti2'];
          var rotta2 = value['rotta2'];
          var costo2 = parseFloat(Math.round(value['costo2'] * 100) / 100).toFixed(2);
          createTableConsegne('bodyTable2', clienti2, rotta2);

          var risultato = value['risultato'].split(';')
          var costoIniziale1 = parseFloat(Math.round(risultato[0] * 100) / 100).toFixed(2);
          var costoIniziale2 = parseFloat(Math.round(risultato[1] * 100) / 100).toFixed(2);

          if (costo1 == costoIniziale1 && costo2 == costoIniziale2) {
            document.getElementById(2).innerHTML = "Non è stato possibile migliorare i costi con la cooperazione. I percorsi dei due spedizionieri sono invariati.";
          }
          else {
            run3(clienti1, rotta1, costo1, '0', true);
            run3(clienti2, rotta2, costo2, '1', false);
            var testo = "Buone notizie! I costi sono stati migliorati con la cooperazione! I costi dei due spedizionieri prima della cooperazione erano rispettivamente pari a " + costoIniziale1 + " km e " + costoIniziale2 + " km. ";
            testo += "Il numero di clienti scambiato è pari a " + risultato[3] + " con un risparmio di " + parseFloat(Math.round(risultato[2] * 100) / 100).toFixed(2) + " km.";
            document.getElementById(2).innerHTML = testo;
          }

          //run3.clearMap();
        },
        error: function (err) {
          console.log(err);
        }
      });
    }

    var OggettiDaEliminare = [];

    function run3(clienti, rotta, costo, IDrotta, flag) {
      document.getElementById(2).innerHTML = "Nessun dato.";
      // document.getElementById('reset').onclick = clearMap;
      if (flag) {


        for (i = 0; i < OggettiDaEliminare.length; i++) {
          var item = OggettiDaEliminare[i];
          if (map.getLayer(item))
            map.removeLayer(item);
          if (map.getSource(item))
            map.removeSource(item);
        }
        points.forEach(function (item) {
          if (map.getLayer(item)) map.removeLayer(item);
          if (map.getSource(item)) map.removeSource(item);
        });
        c = 0;
        points = [];
        StartingIndex = 0;
      }
      //      clearMap();

      colore = colors[c];
      c++;

      document.getElementById(IDrotta.toString()).innerHTML = "Il costo totale per servire i propri clienti è pari a " + costo + " km.";
      var api = 'https://api.mapbox.com/directions/v5/';


      var profiles = {
        driving: {
          color: colore //'#56b881'//'#3bb2d0'
        }
      };

      Object.keys(clienti).forEach(function (key) {
        //for (i = 0; i < clienti.length; i++) {
        var color = "#000080";

        var TextColor = "#FFFFFF";

        if (key == 0)
          color = "#008000";

        if (key == 0 && StartingIndex > 0)
          return;

        if (StartingIndex > 0) {
          color = "#FF0000";
          //TextColor = "#000000";
        }

        //var index = StartingIndex + i;
        coords = clienti[key];
        lat = coords[0];
        lon = coords[1];
        points.push(key.toString());

        OggettiDaEliminare.push(key.toString());

        map.addSource(key.toString(), {
          type: "geojson",
          data: {
            "type": "FeatureCollection",
            "features": [
              {
                "type": "Feature",
                "geometry": {
                  "type": "Point",
                  "coordinates": [lon, lat]
                },
                "properties": {
                  "nome": key.toString()
                }
              }]
          }
        });
        map.addLayer({
          'id': key.toString(),
          'type': 'circle',
          'source': key.toString(),
          'layout': {},
          'paint': {
            'circle-radius': 16,
            'circle-color': color//'#FF0000'//profiles.driving.color
          }
        });
        var textLabelIcon=key.toString();
        if (key == 0) {
          textLabelIcon="D";
        }
        map.addLayer({
          "id": key.toString() + "-label",
          "type": "symbol",
          "source": key.toString(),
          "layout": {
          "text-field": textLabelIcon,
            "text-font": [
              "DIN Offc Pro Medium",
              "Arial Unicode MS Bold"
            ],
            "text-size": 12
          },
          "paint": {
          "text-color": TextColor
          }
        });
        OggettiDaEliminare.push(key.toString() + "-label");
      });

      requestProfiles(Object.keys(profiles));

      StartingIndex = 1;


      function requestProfiles() {
        var queue = d3.queue();

        Object.keys(profiles).forEach(function (profile) {
          queue.defer(route, profile);
        });

        queue.awaitAll(function (error, results) {
          results.forEach(function (result) {
            if (result && result.profile) {
              profiles[result.profile].route = result.routes[0];
            }
          })
          draw();
        });

        function route(profile, cb) {

          coords = clienti[0];
          lat = coords[0];
          lon = coords[1];

          var percorso = [lon, lat];
          var r = rotta[0][0];
          /* Problema indici
              lon[0]
              16.4857
              lat[0]
              38.926
              rotta[0][0]
              r --> ["3", "4"]
               percorso += ";" + [lon[parseInt(r[i])], lat[parseInt(r[i])]];
               percorso --> 16.4857,38.926;,;,;16.4857,38.926
          */
          for (i = 0; i < r.length; i++) {
            percorso += ";" + [clienti[parseInt(r[i])][1], clienti[parseInt(r[i])][0]];
          }
          percorso += ";" + [lon, lat];

          //console.log(percorso);

          //var middle = [-77.04753807398001, 38.91768142447788];
          //var middle = [16.380523533774532, 39.181744129419634];

          var startEnd = encodeURIComponent(percorso);


          //var startEnd = encodeURIComponent(start + ';' + middle +';' +end + ';' + start);


          var request = new XMLHttpRequest();
          var url = api + 'mapbox/' + profile + '/' + startEnd + '.json?access_token=pk.eyJ1IjoiYWFyb25saWRtYW4iLCJhIjoiNTVucTd0TSJ9.wVh5WkYXWJSBgwnScLupiQ&geometries=geojson&overview=full';

          //console.log(url)

          request.abort();
          request.open('GET', url, true);
          request.send();

          request.onload = function () {
            if (request.status >= 200 && request.status < 400) {
              var data = JSON.parse(request.responseText);
              if (data.error) {
                console.log('error');
                return clear();
              }
              data.profile = profile;
              return cb(null, data);
            } else {
              // never actually error
              return cb(null, false);
            }
          };

          request.onerror = function () {
            return cb(null, false);
          };

        }
      }

      function draw() {
        // I know

        coords = clienti[0];
        lat = coords[0];
        lon = coords[1];

        var bounds = new mapboxgl.LngLatBounds([lon, lat], [lon, lat]);

        //var bounds = new mapboxgl.LngLatBounds(start, end);

        Object.keys(profiles).forEach(function (profile, idx) {
          //console.log();
          map.addSource(IDrotta + ' ' + profile + ' route', {
            type: 'geojson',
            data: profiles[profile].route.geometry
          });
          var route = {
            'id': IDrotta + ' ' + profile + ' route',
            'type': 'line',
            'source': IDrotta + ' ' + profile + ' route',
            'layout': {
              'line-join': 'round',
              'line-cap': 'round'
            },
            'paint': {
              'line-color': profiles[profile].color,
              'line-width': 4,
              'line-opacity': 1
            }
          };
          if (profile == 'cycling') route.paint['line-dasharray'] = [2.5, 2.5];
          if (profile == 'walking') route.paint['line-dasharray'] = [0, 1.5];

          map.addLayer(route, '0');
          OggettiDaEliminare.push(route);
          OggettiDaEliminare.push(IDrotta + ' ' + profile + ' route');

          // map.addLayer(route, 'start');
          var result = profiles[profile].route.geometry.coordinates.reduce(function (previous, current) {
            return bounds.extend(current);
          });
        });

        map.fitBounds(bounds, {
          padding: 100
        });

        IDrotta++;
        // console.log(map.style.layers);
      }

      function clearMap() {
        for (i = 0; i < OggettiDaEliminare.length; i++) {
          var item = OggettiDaEliminare[i];
          if (map.getLayer(item)) map.removeLayer(item);
          if (map.getSource(item)) map.removeSource(item);
        }
        points.forEach(function (item) {
          if (map.getLayer(item)) map.removeLayer(item);
          if (map.getSource(item)) map.removeSource(item);
        });

      }
    } // function run3
    function run2(lat, lon, rotta, costo, IDrotta) {

      // document.getElementById('reset').onclick = clearMap;
      colore = colors[c];
      c++;

      document.getElementById(IDrotta.toString()).innerHTML = "Il costo totale per servire i propri clienti è pari a " + costo + ".";
      var api = 'https://api.mapbox.com/directions/v5/';
      var profiles = {
        driving: {
          color: colore //'#56b881'//'#3bb2d0'
        }
      };

      for (i = 0; i < lat.length; i++) {
        var color = "#000080";

        var TextColor = "#FFFFFF";

        if (i == 0)
          color = "#008000";

        if (i == 0 && StartingIndex > 0)
          continue;

        if (StartingIndex > 0) {
          color = "#FF0000";
          TextColor = "#000000";
        }

        var index = StartingIndex + i;
        points.push(index.toString());

        map.addSource(index.toString(), {
          type: "geojson",
          data: {
            "type": "FeatureCollection",
            "features": [
              {
                "type": "Feature",
                "geometry": {
                  "type": "Point",
                  "coordinates": [lon[i], lat[i]]
                },
                "properties": {
                  "nome": index.toString()
                }
              }]
          }
        });
        map.addLayer({
          'id': index.toString(),
          'type': 'circle',
          'source': index.toString(),
          'layout': {},
          'paint': {
            'circle-radius': 16,
            'circle-color': color//'#FF0000'//profiles.driving.color
          }
        });
        map.addLayer({
          "id": index.toString() + "-label",
          "type": "symbol",
          "source": index.toString(),
          "layout": {
            "text-field": "{nome}",
            "text-font": [
              "DIN Offc Pro Medium",
              "Arial Unicode MS Bold"
            ],
            "text-size": 12
          },
          "paint": {
            "text-color": TextColor
          }
        });
      }
      requestProfiles(Object.keys(profiles));

      StartingIndex += lat.length - 1;


      function requestProfiles() {
        var queue = d3.queue();

        Object.keys(profiles).forEach(function (profile) {
          queue.defer(route, profile);
        });

        queue.awaitAll(function (error, results) {
          results.forEach(function (result) {
            if (result && result.profile) {
              profiles[result.profile].route = result.routes[0];
            }
          })
          draw();
        });

        function route(profile, cb) {

          var percorso = [lon[0], lat[0]];
          var r = rotta[0][0];

          for (i = 0; i < r.length; i++) {
            percorso += ";" + [lon[parseInt(r[i])], lat[parseInt(r[i])]];
          }
          percorso += ";" + [lon[0], lat[0]];

          console.log(percorso);

          //var middle = [-77.04753807398001, 38.91768142447788];
          //var middle = [16.380523533774532, 39.181744129419634];

          var startEnd = encodeURIComponent(percorso);


          //var startEnd = encodeURIComponent(start + ';' + middle +';' +end + ';' + start);


          var request = new XMLHttpRequest();
          var url = api + 'mapbox/' + profile + '/' + startEnd + '.json?access_token=pk.eyJ1IjoiYWFyb25saWRtYW4iLCJhIjoiNTVucTd0TSJ9.wVh5WkYXWJSBgwnScLupiQ&geometries=geojson&overview=full';

          console.log(url)

          request.abort();
          request.open('GET', url, true);
          request.send();

          request.onload = function () {
            if (request.status >= 200 && request.status < 400) {
              var data = JSON.parse(request.responseText);
              if (data.error) {
                console.log('error');
                return clear();
              }
              data.profile = profile;
              return cb(null, data);
            } else {
              // never actually error
              return cb(null, false);
            }
          };

          request.onerror = function () {
            return cb(null, false);
          };

        }
      }

      function draw() {
        // I know

        var bounds = new mapboxgl.LngLatBounds([lon[0], lat[0]], [lon[0], lat[0]]);

        //var bounds = new mapboxgl.LngLatBounds(start, end);

        Object.keys(profiles).forEach(function (profile, idx) {
          map.addSource(IDrotta + ' ' + profile + ' route', {
            type: 'geojson',
            data: profiles[profile].route.geometry
          });
          var route = {
            'id': IDrotta + ' ' + profile + ' route',
            'type': 'line',
            'source': IDrotta + ' ' + profile + ' route',
            'layout': {
              'line-join': 'round',
              'line-cap': 'round'
            },
            'paint': {
              'line-color': profiles[profile].color,
              'line-width': 4,
              'line-opacity': 1
            }
          };
          if (profile == 'cycling') route.paint['line-dasharray'] = [2.5, 2.5];
          if (profile == 'walking') route.paint['line-dasharray'] = [0, 1.5];

          map.addLayer(route, '0');

          // map.addLayer(route, 'start');

          var result = profiles[profile].route.geometry.coordinates.reduce(function (previous, current) {
            return bounds.extend(current);
          });
        });

        map.fitBounds(bounds, {
          padding: 100
        });

        IDrotta++;
      }

      function clearMap() {
        Object.keys(profiles).forEach(function (profile) {
          for (i = 0; i < IDrotta; i++) {
            if (map.getLayer(i + ' ' + profile + ' route')) map.removeLayer(i + ' ' + profile + ' route');
            if (map.getSource(i + ' ' + profile + ' route')) map.removeSource(i + ' ' + profile + ' route');
          }
        });

        points.forEach(function (item) {
          if (map.getLayer(item)) map.removeLayer(item);
          if (map.getSource(item)) map.removeSource(item);
        });
      }
    } // function run2

    function run() {

      // document.getElementById('reset').onclick = clearMap;
      colore = colors[c];
      c++;

      //var value = JSON.parse(document.getElementById('hello-data').textContent);
      //console.log(value)
      //var deposito = value["deposito"]

      //var end = value["c2"]
      //var middle = value["c1"]

      var lat = value['lat']
      var lon = value['lon']
      var rotta = value['rotta']
      var costo = parseFloat(Math.round(value['costo'] * 100) / 100).toFixed(2);

      document.getElementById(IDrotta.toString()).innerHTML = "Il costo totale per servire i propri clienti è pari a " + costo + ".";
      /*
      var map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v9',
          center: [lon[0], lat[0]], //deposito,//[16.48757,38.92574],
          zoom: 10,
          hash: true
      });

      map.scrollZoom.disable();
      var nav = new mapboxgl.NavigationControl();
      map.addControl(nav, 'top-left');
      */


      //var start = [-77.04753807398001, 38.90378612315598];


      //var start = deposito;

      //[16.48757,38.92574];
      //var end = [-77.02701979834258, 38.91768142447788];
      //var end = [16.692104177184746, 39.18847606525372];

      var api = 'https://api.mapbox.com/directions/v5/';
      var profiles = {
        driving: {
          color: colore //'#56b881'//'#3bb2d0'
        }
        /*,
          cycling: {
              color: '#56b881'
          },
          walking: {
              color: '#fbb03b'
          }*/
      };

      //map.on('click', go);


      /*
        if (e.type === 'click' && !start)
            start = [e.lngLat.lng, e.lngLat.lat];
      */

      for (i = 0; i < lat.length; i++) {
        var color = "#000080";

        var TextColor = "#FFFFFF";

        if (i == 0)
          color = "#008000";

        if (i == 0 && StartingIndex > 0)
          continue;

        if (StartingIndex > 0) {
          color = "#FF0000";
          TextColor = "#000000";
        }

        var index = StartingIndex + i;
        points.push(index.toString());

        map.addSource(index.toString(), {
          type: "geojson",
          data: {
            "type": "FeatureCollection",
            "features": [
              {
                "type": "Feature",
                "geometry": {
                  "type": "Point",
                  "coordinates": [lon[i], lat[i]]
                },
                "properties": {
                  "nome": index.toString()
                }
              }]
          }
        });
        map.addLayer({
          'id': index.toString(),
          'type': 'circle',
          'source': index.toString(),
          'layout': {},
          'paint': {
            'circle-radius': 16,
            'circle-color': color//'#FF0000'//profiles.driving.color
          }
        });
        map.addLayer({
          "id": index.toString() + "-label",
          "type": "symbol",
          "source": index.toString(),
          "layout": {
            "text-field": "{nome}",
            "text-font": [
              "DIN Offc Pro Medium",
              "Arial Unicode MS Bold"
            ],
            "text-size": 12
          },
          "paint": {
            "text-color": TextColor
          }
        });
        /*
               var el = document.createElement('div');
                el.className = 'mapboxgl-marker mapboxgl-marker-anchor-center';
                el.style.left = '-15px';
                el.style.top = '-32px';
                el.style.transform = 'translate(-50%, -50%)';
                */
      }
      /*
        if (!map.getSource('start')) {
            map.addSource('start', {
                type: 'geojson',
                data: {
                    type: 'Point',
                    coordinates: [start[0], start[1]]
                }
            });

            map.addLayer({
                'id': 'start',
                'type': 'circle',
                'source': 'start',
                'layout': {},
                'paint': {
                    'circle-radius': 10,
                    'circle-color': '#FF0000'//profiles.driving.color
                }
            });
        }

        if (e.type === 'click') {
            end = [e.lngLat.lng, e.lngLat.lat];
            if (end.toString() === start.toString()) {
                end = null;
                return
            }
        }

        map.addSource('end', {
            type: 'geojson',
            data: {
                type: 'Point',
                coordinates: [end[0], end[1]]
            }
        });

        map.addLayer({
            'id': 'end',
            'type': 'circle',
            'source': 'end',
            'layout': {},
            'paint': {
                'circle-radius': 10,
                'circle-color': '#FF0000'//profiles.driving.color
            }
        });


      map.addSource('middle', {
            type: 'geojson',
            data: {
                type: 'Point',
                  coordinates: middle, //[16.380523533774532, 39.181744129419634]
                //coordinates: [-77.04753807398001, 38.91768142447788]
            }
        });

        map.addLayer({
            'id': 'middle',
            'type': 'circle',
          'source': 'middle',
            'layout': {},
            'paint': {
                'circle-radius': 10,
                'circle-color': '#FF0000'//profiles.driving.color
            }
        });

    */

      requestProfiles(Object.keys(profiles));
      // if (start && end) requestProfiles(start, end, Object.keys(profiles));


      StartingIndex += lat.length - 1;


      function requestProfiles() {
        var queue = d3.queue();

        Object.keys(profiles).forEach(function (profile) {
          queue.defer(route, profile);
        });

        queue.awaitAll(function (error, results) {
          results.forEach(function (result) {
            if (result && result.profile) {
              profiles[result.profile].route = result.routes[0];
            }
          })
          draw();
        });

        function route(profile, cb) {

          var percorso = [lon[0], lat[0]];
          var r = rotta[0][0];

          for (i = 0; i < r.length; i++) {
            percorso += ";" + [lon[parseInt(r[i])], lat[parseInt(r[i])]];
          }
          percorso += ";" + [lon[0], lat[0]];

          console.log(percorso);

          //var middle = [-77.04753807398001, 38.91768142447788];
          //var middle = [16.380523533774532, 39.181744129419634];

          var startEnd = encodeURIComponent(percorso);


          //var startEnd = encodeURIComponent(start + ';' + middle +';' +end + ';' + start);


          var request = new XMLHttpRequest();
          var url = api + 'mapbox/' + profile + '/' + startEnd + '.json?access_token=pk.eyJ1IjoiYWFyb25saWRtYW4iLCJhIjoiNTVucTd0TSJ9.wVh5WkYXWJSBgwnScLupiQ&geometries=geojson&overview=full';

          console.log(url)

          request.abort();
          request.open('GET', url, true);
          request.send();

          request.onload = function () {
            if (request.status >= 200 && request.status < 400) {
              var data = JSON.parse(request.responseText);
              if (data.error) {
                console.log('error');
                return clear();
              }
              data.profile = profile;
              return cb(null, data);
            } else {
              // never actually error
              return cb(null, false);
            }
          };

          request.onerror = function () {
            return cb(null, false);
          };

        }
      }

      function draw() {
        // I know

        var bounds = new mapboxgl.LngLatBounds([lon[0], lat[0]], [lon[0], lat[0]]);

        //var bounds = new mapboxgl.LngLatBounds(start, end);

        Object.keys(profiles).forEach(function (profile, idx) {
          map.addSource(IDrotta + ' ' + profile + ' route', {
            type: 'geojson',
            data: profiles[profile].route.geometry
          });
          var route = {
            'id': IDrotta + ' ' + profile + ' route',
            'type': 'line',
            'source': IDrotta + ' ' + profile + ' route',
            'layout': {
              'line-join': 'round',
              'line-cap': 'round'
            },
            'paint': {
              'line-color': profiles[profile].color,
              'line-width': 4,
              'line-opacity': 1
            }
          };
          if (profile == 'cycling') route.paint['line-dasharray'] = [2.5, 2.5];
          if (profile == 'walking') route.paint['line-dasharray'] = [0, 1.5];

          map.addLayer(route, '0');

          // map.addLayer(route, 'start');

          var result = profiles[profile].route.geometry.coordinates.reduce(function (previous, current) {
            return bounds.extend(current);
          });
        });

        map.fitBounds(bounds, {
          padding: 100
        });

        IDrotta++;
      }

      function clearMap() {
        Object.keys(profiles).forEach(function (profile) {
          for (i = 0; i < IDrotta; i++) {
            if (map.getLayer(i + ' ' + profile + ' route')) map.removeLayer(i + ' ' + profile + ' route');
            if (map.getSource(i + ' ' + profile + ' route')) map.removeSource(i + ' ' + profile + ' route');
          }
        });

        points.forEach(function (item) {
          if (map.getLayer(item)) map.removeLayer(item);
          if (map.getSource(item)) map.removeSource(item);
        });
      }
    } // function run

//run();

    /*
    function animation() {
           // Add source for the car icon layer
               map.addSource('point', {
                        "type": "geojson",
                        "data": point
                    });
                    // Add car icon layer
               map.addLayer({
                        "id": "point",
                        "source": "point",
                        "type": "symbol",
                        "layout": {
                            "icon-image": "car-15",
                            "icon-size": 1,
                        }
                });
                function animate() {
                        point.features[0].geometry.coordinates = route.geometry.coordinates[counter]
                        map.getSource('point').setData(point);
                        if (point.features[0].geometry.coordinates[0] !== destination[0]) {
                            requestAnimationFrame(animate);
                        }
                        counter = counter + 1;
                    }
                    animate();
    } */

  </script>

  <!--
<script>
  var value = JSON.parse(document.getElementById('hello-data').textContent);
  //console.log(value);
</script>
-->

  <script src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>

</body>

</html>